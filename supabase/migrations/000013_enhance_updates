-- Remove comment type from update_type enum
ALTER TYPE update_type DROP VALUE IF EXISTS 'comment';

-- Modify comments table to support object linking and threading
ALTER TABLE comments 
ADD COLUMN object_type TEXT,
ADD COLUMN object_id UUID,
ADD COLUMN parent_id UUID REFERENCES comments(id),
ADD CONSTRAINT valid_object_type CHECK (object_type IN ('goal', 'task', 'milestone', 'resource', 'update')),
ADD CONSTRAINT valid_parent CHECK (
    (parent_id IS NULL AND update_id IS NULL AND object_id IS NOT NULL) OR
    (parent_id IS NOT NULL AND update_id IS NULL AND object_id IS NULL) OR
    (update_id IS NOT NULL AND parent_id IS NULL AND object_id IS NULL)
);